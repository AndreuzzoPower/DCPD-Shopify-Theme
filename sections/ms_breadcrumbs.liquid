{%- comment -%}
  MS Breadcrumbs
  ═══════════════════════════════════════════════════════════════
  REQUISITI:
  1) Creare un metafield nei prodotti > product.metafields.custom.breadcrumbs_custom (tipo: Collection / Elenco)
  2) Creare un metafield nelle collections > collection.metafields.custom.breadcrumbs_custom (tipo: Collection / Elenco)
  Per funzionare il link passato al prodotto non deve avere la collection altrimenti verrà presa questa.
{%- endcomment -%}

{{ 'ms_breadcrumbs.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign u = shop.url
  assign prod-use-all-cat = section.settings.show_all_collections
  assign prod-use-all-cat-filter = section.settings.collections_banned | split: ','
  assign prod-show-cat-handle = section.settings.show_cat_handle
  assign cat-use-menu = section.settings.menu_handle
-%}

{%- unless template == 'index' or template == 'list-collections' or template == '404' or template == blank -%}

  {%- comment -%}Stile dinamico: separatore personalizzabile{%- endcomment -%}
  {%- liquid
    assign has_separator_icon = false
    if section.settings.separator_icon != blank
      assign has_separator_icon = true
    endif
    assign has_home_icon = false
    if section.settings.home_icon != blank
      assign has_home_icon = true
    endif
  -%}
  {%- style -%}
    #section-{{ section.id }} {
      {%- if has_separator_icon -%}
        --ms-breadcrumb-separator-icon: url('{{ section.settings.separator_icon | asset_url }}');
      {%- else -%}
        --ms-breadcrumb-separator: '{{ section.settings.separator | replace: "'", "\\'" }}';
      {%- endif -%}
    }
  {%- endstyle -%}

  {%- assign t = template | split: '.' | first -%}

  <div id="section-{{ section.id }}" class="ms-breadcrumb ms-breadcrumb--{{ section.settings.alignment }} {% if has_separator_icon %}ms-breadcrumb--icon-separator{% else %}ms-breadcrumb--text-separator{% endif %} color-{{ section.settings.color_scheme }} gradient {{ section.settings.wrapperclass | escape }}">
    {%- if section.settings.section_width != 'full_width' -%}
      <div class="page-width">
    {%- endif -%}

    <nav aria-label="Breadcrumb">
      <ol class="ms-breadcrumb__list">
        {%- comment -%}═══ Home ═══{%- endcomment -%}
        <li class="ms-breadcrumb__item">
          <a href="{{ routes.root_url }}"{% if has_home_icon %} aria-label="{{ section.settings.home_lbl | escape }}"{% endif %}>
            {%- if has_home_icon -%}
              <span class="ms-breadcrumb__home-icon" aria-hidden="true">
                {{- section.settings.home_icon | inline_asset_content -}}
              </span>
              <span class="visually-hidden">{{ section.settings.home_lbl | escape }}</span>
            {%- else -%}
              {{- section.settings.home_lbl | escape -}}
            {%- endif -%}
          </a>
        </li>

        {%- comment -%}═══ Schema JSON-LD: Home ═══{%- endcomment -%}
        {% capture ms_schema %}
          {
            "@type": "ListItem",
            "position": 1,
            "name": "Home",
            "item": "{{ u | append: routes.root_url }}"
          }
        {% endcapture %}

        {%- case t -%}

          {%- comment -%}
            ═══════════════════════════════════════
            PAGINA
            ═══════════════════════════════════════
          {%- endcomment -%}
          {%- when 'page' -%}
            <li class="ms-breadcrumb__item ms-breadcrumb__item--current" aria-current="page">{{ page.title }}</li>
            {% capture ms_schema %}
              {{ ms_schema }}
              ,{
                "@type": "ListItem",
                "position": 2,
                "name": "{{ page.title }}",
                "item": "{{ u | append: page.url }}"
              }
            {% endcapture %}

          {%- comment -%}
            ═══════════════════════════════════════
            PRODOTTO
            ═══════════════════════════════════════
          {%- endcomment -%}
          {%- when 'product' -%}
            {% assign product-position = 2 -%}

            {%- if collection.url -%}
              {%- comment -%}Collection dall'URL{%- endcomment -%}
              <li class="ms-breadcrumb__item">{{ collection.title | link_to: collection.url }}</li>
              {% capture ms_schema %}
                {{ ms_schema }}
                ,{
                  "@type": "ListItem",
                  "position": 2,
                  "name": "{{ collection.title }}",
                  "item": "{{ u | append: collection.url }}"
                }
              {% endcapture %}
              {% assign product-position = 3 %}

            {%- else -%}

              {%- if product.metafields.custom.breadcrumbs_custom_page != blank -%}
                {%- comment -%}Metafield pagina custom{%- endcomment -%}
                {% assign pos = 2 %}
                {% assign custom_page = product.metafields.custom.breadcrumbs_custom_page.value %}
                <li class="ms-breadcrumb__item">{{ custom_page.title | link_to: custom_page.url }}</li>
                {% capture ms_schema %}
                  {{ ms_schema }}
                  ,{
                    "@type": "ListItem",
                    "position": {{ pos }},
                    "name": "{{ custom_page.title }}",
                    "item": "{{ u | append: custom_page.url }}"
                  }
                {% endcapture %}
                {% assign product-position = 3 %}

              {%- elsif product.metafields.custom.breadcrumbs_custom != blank -%}
                {%- comment -%}Metafield breadcrumbs custom (elenco collections){%- endcomment -%}
                {% assign pos = 1 %}
                {% for bcc in product.metafields.custom.breadcrumbs_custom.value %}
                  {% assign pos = pos | plus: 1 %}
                  {% if prod-show-cat-handle %}
                    {% assign coll-title = bcc.handle | replace: '-', ' ' | replace: '_', ' ' | capitalize %}
                  {% else %}
                    {% assign coll-title = bcc.title | split: '|' | last %}
                  {% endif %}
                  <li class="ms-breadcrumb__item">{{ coll-title | link_to: bcc.url }}</li>
                  {% capture ms_schema %}
                    {{ ms_schema }}
                    ,{
                      "@type": "ListItem",
                      "position": {{ pos }},
                      "name": "{{ coll-title }}",
                      "item": "{{ u | append: bcc.url }}"
                    }
                  {% endcapture %}
                {% endfor %}
                {% assign pos = pos | plus: 1 %}
                {% assign product-position = pos %}

              {%- elsif prod-use-all-cat -%}
                {%- comment -%}Tutte le collezioni associate al prodotto{%- endcomment -%}
                {% assign pos = 1 %}
                {% for collection in product.collections %}
                  {% unless prod-use-all-cat-filter contains collection.handle
                    or collection.handle contains '-sale'
                    or collection.handle contains 'sales-'
                    or collection.handle contains 'saldi'
                    or collection.handle contains 'verkauf'
                  %}
                    {% assign pos = pos | plus: 1 %}
                    {% if prod-show-cat-handle %}
                      {% assign coll-title = collection.handle | replace: '-', ' ' | replace: '_', ' ' | capitalize %}
                    {% else %}
                      {% assign coll-title = collection.title | split: '|' | last %}
                    {% endif %}
                    <li class="ms-breadcrumb__item">{{ coll-title | link_to: collection.url }}</li>
                    {% capture ms_schema %}
                      {{ ms_schema }}
                      ,{
                        "@type": "ListItem",
                        "position": {{ pos }},
                        "name": "{{ coll-title }}",
                        "item": "{{ u | append: collection.url }}"
                      }
                    {% endcapture %}
                  {% endunless %}
                {% endfor %}
                {% assign pos = pos | plus: 1 %}
                {% assign product-position = pos %}

              {%- endif -%}
            {%- endif -%}

            {%- comment -%}Prodotto corrente{%- endcomment -%}
            <li class="ms-breadcrumb__item ms-breadcrumb__item--current" aria-current="page">{{ product.title }}</li>
            {% capture ms_schema %}
              {%- if product-position > 1 -%}
                {{ ms_schema }}
              {%- endif -%}
              ,{
                "@type": "ListItem",
                "position": {{ product-position }},
                "name": "{{ product.title }}",
                "item": "{{ u | append: product.url }}"
              }
            {% endcapture %}

          {%- comment -%}
            ═══════════════════════════════════════
            COLLEZIONE
            ═══════════════════════════════════════
          {%- endcomment -%}
          {%- when 'collection' and collection.handle -%}
            {% assign collection-position = 2 %}

            {%- if collection.metafields.custom.breadcrumbs_custom != blank -%}
              {%- comment -%}Metafield breadcrumbs custom (elenco collections){%- endcomment -%}
              {% assign pos = 1 %}
              {% for bccc in collection.metafields.custom.breadcrumbs_custom.value %}
                {% assign pos = pos | plus: 1 %}
                {% if prod-show-cat-handle %}
                  {% assign coll-title = bccc.handle | replace: '-', ' ' | replace: '_', ' ' %}
                {% else %}
                  {% assign coll-title = bccc.title | split: '|' | last %}
                {% endif %}
                <li class="ms-breadcrumb__item">{{ coll-title | link_to: bccc.url }}</li>
                {% capture ms_schema %}
                  {{ ms_schema }}
                  ,{
                    "@type": "ListItem",
                    "position": {{ pos }},
                    "name": "{{ coll-title }}",
                    "item": "{{ u | append: bccc.url }}"
                  }
                {% endcapture %}
              {% endfor %}
              {% assign pos = pos | plus: 1 %}
              {% assign collection-position = pos %}

            {%- elsif cat-use-menu -%}
              {%- comment -%}Navigazione alberatura menu (fino a 4 livelli){%- endcomment -%}
              {% assign found = false %}
              {% assign collection-position = 2 %}

              {%- for link in linklists[cat-use-menu].links -%}
                {% if found == true %}
                  {% break %}
                {% endif %}

                {% capture currentBC %}
                  <li class="ms-breadcrumb__item">{{ link.title | link_to: link.url }}</li>
                {% endcapture %}
                {% capture ms_schema_1 %}
                  ,{
                    "@type": "ListItem",
                    "position": 2,
                    "name": "{{ link.title }}",
                    "item": "{{ u | append: link.url }}"
                  }
                {% endcapture %}

                {% assign currentHandle = link.url | split: '/collections/' | last %}
                {% if currentHandle == collection.handle %}
                  {% break %}
                {% endif %}

                {%- comment -%}Secondo livello{%- endcomment -%}
                {% if link.links != blank %}
                  {%- for link-lev-2 in link.links -%}
                    {% capture currentBC-lev-2 %}
                      <li class="ms-breadcrumb__item">{{ link-lev-2.title | link_to: link-lev-2.url }}</li>
                    {% endcapture %}
                    {% capture ms_schema_2 %}
                      ,{
                        "@type": "ListItem",
                        "position": 3,
                        "name": "{{ link-lev-2.title }}",
                        "item": "{{ u | append: link-lev-2.url }}"
                      }
                    {% endcapture %}

                    {% assign currentHandle = link-lev-2.url | split: '/collections/' | last %}
                    {% if currentHandle == collection.handle %}
                      {{ currentBC }}
                      {% assign found = true %}
                      {% assign collection-position = 3 %}
                      {% capture ms_schema %}
                        {{ ms_schema }}{{ ms_schema_1 }}
                      {% endcapture %}
                      {% break %}
                    {% endif %}

                    {%- comment -%}Terzo livello{%- endcomment -%}
                    {% if link-lev-2.links != blank %}
                      {%- for link-lev-3 in link-lev-2.links -%}
                        {% capture currentBC-lev-3 %}
                          <li class="ms-breadcrumb__item">{{ link-lev-3.title | link_to: link-lev-3.url }}</li>
                        {% endcapture %}
                        {% capture ms_schema_3 %}
                          ,{
                            "@type": "ListItem",
                            "position": 4,
                            "name": "{{ link-lev-3.title }}",
                            "item": "{{ u | append: link-lev-3.url }}"
                          }
                        {% endcapture %}

                        {% assign currentHandle = link-lev-3.url | split: '/collections/' | last %}
                        {% if currentHandle == collection.handle %}
                          {{ currentBC -}}
                          {{- currentBC-lev-2 }}
                          {% assign found = true %}
                          {% assign collection-position = 4 %}
                          {% capture ms_schema %}
                            {{ ms_schema }}{{ ms_schema_1 }}{{ ms_schema_2 }}
                          {% endcapture %}
                          {% break %}
                        {% endif %}

                        {%- comment -%}Quarto livello{%- endcomment -%}
                        {% if link-lev-3.links != blank %}
                          {%- for link-lev-4 in link-lev-3.links -%}
                            {% capture currentBC-lev-4 %}
                              <li class="ms-breadcrumb__item">{{ link-lev-4.title | link_to: link-lev-4.url }}</li>
                            {% endcapture %}
                            {% capture ms_schema_4 %}
                              ,{
                                "@type": "ListItem",
                                "position": 5,
                                "name": "{{ link-lev-4.title }}",
                                "item": "{{ u | append: link-lev-4.url }}"
                              }
                            {% endcapture %}

                            {% assign currentHandle = link-lev-4.url | split: '/collections/' | last %}
                            {% if currentHandle == collection.handle %}
                              {{ currentBC -}}
                              {{- currentBC-lev-2 -}}
                              {{- currentBC-lev-3 }}
                              {% assign found = true %}
                              {% assign collection-position = 5 %}
                              {% capture ms_schema %}
                                {{ ms_schema }}{{ ms_schema_1 }}{{ ms_schema_2 }}{{ ms_schema_3 }}
                              {% endcapture %}
                              {% break %}
                            {% endif %}
                          {%- endfor -%}
                        {% endif %}
                      {%- endfor -%}
                    {% endif %}
                  {%- endfor -%}
                {% endif %}
              {%- endfor -%}
            {%- endif -%}

            {%- comment -%}Collezione corrente{%- endcomment -%}
            {% if prod-show-cat-handle %}
              {% assign cur-coll-title = collection.handle | replace: '-', ' ' | replace: '_', ' ' | capitalize %}
            {% else %}
              {% assign cur-coll-title = collection.title | split: '|' | last %}
            {% endif %}
            <li class="ms-breadcrumb__item ms-breadcrumb__item--current" aria-current="page">{{ cur-coll-title }}</li>
            {% capture ms_schema %}
              {%- if collection-position > 1 -%}
                {{ ms_schema }}
              {%- endif -%}
              ,{
                "@type": "ListItem",
                "position": {{ collection-position }},
                "name": "{{ cur-coll-title }}",
                "item": "{{ u | append: collection.url }}"
              }
            {% endcapture %}

            {%- if current_tags -%}
            {%- endif -%}

          {%- comment -%}
            ═══════════════════════════════════════
            BLOG
            ═══════════════════════════════════════
          {%- endcomment -%}
          {%- when 'blog' -%}
            {%- if current_tags -%}
              <li class="ms-breadcrumb__item">{{ blog.title | link_to: blog.url }}</li>
              {%- capture tag_url -%}{{ blog.url }}/tagged/{{ current_tags | join: '+' }}{%- endcapture -%}
              <li class="ms-breadcrumb__item ms-breadcrumb__item--current" aria-current="page">{{- current_tags | join: ' + ' -}}</li>
            {%- else -%}
              <li class="ms-breadcrumb__item ms-breadcrumb__item--current" aria-current="page">{{ blog.title }}</li>
            {%- endif -%}
            {% capture ms_schema %}
              {{ ms_schema }}
              ,{
                "@type": "ListItem",
                "position": 2,
                "name": "{{ blog.title }}",
                "item": "{{ u | append: blog.url }}"
              }
            {% endcapture %}

          {%- comment -%}
            ═══════════════════════════════════════
            ARTICOLO
            ═══════════════════════════════════════
          {%- endcomment -%}
          {%- when 'article' -%}
            <li class="ms-breadcrumb__item">{{ blog.title | link_to: blog.url }}</li>
            <li class="ms-breadcrumb__item ms-breadcrumb__item--current" aria-current="page">{{ article.title }}</li>
            {% capture ms_schema %}
              {{ ms_schema }}
              ,{
                "@type": "ListItem",
                "position": 2,
                "name": "{{ blog.title }}",
                "item": "{{ u | append: blog.url }}"
              }
              ,{
                "@type": "ListItem",
                "position": 3,
                "name": "{{ article.title }}",
                "item": "{{ u | append: article.url }}"
              }
            {% endcapture %}

          {%- comment -%}
            ═══════════════════════════════════════
            ALTRI (search, customers, cart, ecc.)
            ═══════════════════════════════════════
          {%- endcomment -%}
          {%- else -%}
            {% assign current_pt = page_title %}
            {%- if template contains 'search' -%}
              {% assign current_pt = 'Search' %}
            {%- elsif template contains 'customers' -%}
              {% assign current_pt = 'Profile' %}
            {%- elsif template contains 'cart' -%}
              {% assign current_pt = 'Cart' %}
            {%- endif -%}
            <li class="ms-breadcrumb__item ms-breadcrumb__item--current" aria-current="page">{{ current_pt }}</li>
            {% capture ms_schema %}
              {{ ms_schema }}
              ,{
                "@type": "ListItem",
                "position": 2,
                "name": "{{ current_pt }}",
                "item": "{{ u | append: page.url }}"
              }
            {% endcapture %}
        {%- endcase -%}
      </ol>
    </nav>

    {%- if section.settings.section_width != 'full_width' -%}
      </div>
    {%- endif -%}
  </div>

  {%- comment -%}═══ Dati Strutturati JSON-LD: BreadcrumbList ═══{%- endcomment -%}
  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {{ ms_schema }}
      ]
    }
  </script>

  {%- render 'ms_section-style' -%}
{%- endunless -%}

{% schema %}
{
  "name": "MS Breadcrumbs",
  "settings": [
    {
      "type": "header",
      "content": "Larghezza sezione"
    },
    {
      "type": "select",
      "id": "section_width",
      "label": "Section Width",
      "options": [
        { "label": "Full Width", "value": "full_width" },
        { "label": "Default Width", "value": "default" },
        { "label": "Page width", "value": "page_width" }
      ],
      "default": "default"
    },
    {
      "type": "header",
      "content": "Stile"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "alignment",
      "label": "Allineamento",
      "options": [
        { "label": "Sinistra", "value": "left" },
        { "label": "Centro", "value": "center" },
        { "label": "Destra", "value": "right" }
      ],
      "default": "center"
    },
    {
      "type": "text",
      "id": "home_lbl",
      "label": "Etichetta Home",
      "default": "Home",
      "info": "Testo per il link alla homepage. Visibile anche come testo accessibile se si usa un'icona."
    },
    {
      "type": "text",
      "id": "home_icon",
      "label": "Icona Home (SVG)",
      "info": "Nome del file SVG presente negli assets (es. icon-home.svg). Se compilato, l'icona sostituisce il testo visibile."
    },
    {
      "type": "text",
      "id": "separator",
      "label": "Separatore testo",
      "default": "/",
      "info": "Carattere tra gli elementi (es. /, ›, >, »). Ignorato se è impostata un'icona separatore."
    },
    {
      "type": "text",
      "id": "separator_icon",
      "label": "Icona separatore (SVG)",
      "info": "Nome del file SVG presente negli assets (es. icon-chevron-right.svg). Se compilato, sostituisce il separatore testo."
    },
    {
      "type": "text",
      "id": "wrapperclass",
      "label": "Classi CSS wrapper personalizzate",
      "info": "Classi aggiuntive sul contenitore principale (opzionale)"
    },
    {
      "type": "header",
      "content": "Impostazioni categorie"
    },
    {
      "type": "text",
      "id": "menu_handle",
      "label": "Handle menu categorie",
      "info": "Inserisci l'handle del menu da usare come alberatura per le breadcrumbs delle categorie. Lascia vuoto per disattivare."
    },
    {
      "type": "header",
      "content": "Impostazioni prodotti"
    },
    {
      "type": "checkbox",
      "id": "show_all_collections",
      "label": "Mostra tutte le collezioni nella scheda prodotto",
      "info": "Se attivo, nella scheda prodotto vengono mostrate tutte le collezioni associate.",
      "default": false
    },
    {
      "type": "textarea",
      "id": "collections_banned",
      "label": "Filtro categorie",
      "info": "Handle delle collezioni da escludere, separate da virgola."
    },
    {
      "type": "checkbox",
      "id": "show_cat_handle",
      "label": "Mostra handle collezione",
      "info": "Mostra l'handle della collezione invece del titolo.",
      "default": false
    }
  ],
  "blocks": [
    {
      "type": "section_padding",
      "name": "Section Padding",
      "limit": 1,
      "settings": [
        { "type": "header", "content": "Large/Desktop Device" },
        { "type": "range", "id": "section_padding_top", "min": 0, "max": 150, "step": 5, "label": "Padding Top", "unit": "px", "default": 0 },
        { "type": "range", "id": "section_padding_bottom", "min": 0, "max": 150, "step": 5, "label": "Padding Bottom", "unit": "px", "default": 0 },
        { "type": "header", "content": "Tablet Device" },
        { "type": "range", "id": "section_padding_top_md", "min": 0, "max": 150, "step": 5, "label": "Padding Top", "unit": "px", "default": 0 },
        { "type": "range", "id": "section_padding_bottom_md", "min": 0, "max": 150, "step": 5, "label": "Padding Bottom", "unit": "px", "default": 0 },
        { "type": "header", "content": "Mobile Device" },
        { "type": "range", "id": "section_padding_top_xs", "min": 0, "max": 150, "step": 5, "label": "Padding Top", "unit": "px", "default": 0 },
        { "type": "range", "id": "section_padding_bottom_xs", "min": 0, "max": 150, "step": 5, "label": "Padding Bottom", "unit": "px", "default": 0 }
      ]
    },
    {
      "type": "section_margin",
      "name": "Section Margin",
      "limit": 1,
      "settings": [
        { "type": "header", "content": "Large/Desktop Device" },
        { "type": "range", "id": "section_margin_top", "min": 0, "max": 150, "step": 5, "label": "Margin Top", "unit": "px", "default": 0 },
        { "type": "range", "id": "section_margin_bottom", "min": 0, "max": 150, "step": 5, "label": "Margin Bottom", "unit": "px", "default": 0 },
        { "type": "header", "content": "Tablet Device" },
        { "type": "range", "id": "section_margin_top_md", "min": 0, "max": 150, "step": 5, "label": "Margin Top", "unit": "px", "default": 0 },
        { "type": "range", "id": "section_margin_bottom_md", "min": 0, "max": 150, "step": 5, "label": "Margin Bottom", "unit": "px", "default": 0 },
        { "type": "header", "content": "Mobile Device" },
        { "type": "range", "id": "section_margin_top_xs", "min": 0, "max": 150, "step": 5, "label": "Margin Top", "unit": "px", "default": 0 },
        { "type": "range", "id": "section_margin_bottom_xs", "min": 0, "max": 150, "step": 5, "label": "Margin Bottom", "unit": "px", "default": 0 }
      ]
    },
    {
      "type": "section_background",
      "name": "Section Background",
      "limit": 1,
      "settings": [
        { "type": "image_picker", "id": "section_bg_image", "label": "BG Image" },
        { "type": "color", "id": "section_bg_color", "label": "BG Color", "default": "#ffffff" }
      ]
    }
  ],
  "presets": [
    {
      "name": "MS Breadcrumbs",
      "category": "Navigazione",
      "blocks": [
        { "type": "section_padding" }
      ]
    }
  ],
  "disabled_on": {
    "groups": ["footer"]
  }
}
{% endschema %}
